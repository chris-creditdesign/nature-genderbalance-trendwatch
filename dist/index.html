<style scoped>
.widget-status-message, .widget-error-message {
  border: 1px solid #c00;
  background: #fac7c7;
  padding: 10px;
  display: none;
}

.outerwrapper {
  width: 100%;
  position: relative;
  border: 1px solid #c8c7cf;
  display: none;
}
.outerwrapper .header {
  margin: 0px 0px 20px;
}
.outerwrapper .header h2 {
  padding: 10px 15px;
  margin: 0;
}
.outerwrapper .header p {
  padding: 0 15px;
  margin: 0px 0px 10px;
}
.outerwrapper .chart {
  position: relative;
  line-height: 0;
  margin: 0 15px 15px;
}
.outerwrapper .chart h3 {
  position: absolute;
  margin: 0;
  top: 20px;
  left: 10px;
  z-index: 99;
  font-size: 1.5em;
  -webkit-user-select: none;
     -moz-user-select: none;
      -ms-user-select: none;
          user-select: none;
}
.outerwrapper .chart svg {
  cursor: crosshair;
}
.outerwrapper .chart svg .country path {
  cursor: pointer;
}
.outerwrapper .key {
  margin-bottom: 10px;
}
.outerwrapper .key h3 {
  padding: 0 15px 5px;
  margin: 0;
}
.outerwrapper .key ul {
  margin: 0px 15px 0px 5px;
  padding: 0;
}
.outerwrapper .key li {
  display: inline-block;
  margin-top: 5px;
  margin-left: 10px;
  padding-left: 5px;
  padding-top: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 10px;
  line-height: 1em;
  border-left: 1px solid black;
  min-width: 60px;
}
.outerwrapper .widget-tooltip {
  position: absolute;
  width: 200px;
  height: auto;
  padding: 6px 10px 6px 15px;
  color: #ccc;
  background-color: #333;
  pointer-events: none;
  border-radius: 5px;
  font-size: 0.8em;
  line-height: 1.4em;
  opacity: 1;
  transition: opacity 0.2s ease;
}
.outerwrapper .widget-tooltip p {
  padding: 0;
  margin: 0;
}
.outerwrapper .widget-tooltip span {
  font-weight: bold;
  color: #fff;
}
.outerwrapper .widget-tooltip-hidden {
  opacity: 0;
  pointer-events: none;
}

</style>
<noscript>
	This interactive graphic requires javascript to be enabled.
</noscript>

<div class="widget-status-message" id="widget-status-message">
	<p>This interactive graphic requires a modern browser (e.g. Chrome, Safari or Firefox) with javascript enabled.</p>
</div>

<div class="widget-error-message">
	<p>The data needed for this interactive graphic has failed to load.</p>
</div>


<div class="outerwrapper">
	<div class="header">
		<h2>INTERACTIVE: Headline</h2>
		<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Numquam id impedit, eos fugit, similique cum, voluptate quis laborum nulla consequuntur quas eveniet obcaecati alias vel perspiciatis fugiat odit hic at.</p>
	</div>

	<div class="key" id="key">
		<h3>Women as percentage of members of national science academies, by individual academy</h3>
	</div>

	<div class="chart" id="chart">
		<div class="widget-tooltip widget-tooltip-hidden" id="widget-tooltip">
			<p><span id="country"></span></p>
			<p id="academy"></p>
			<p>Women members: <span id="women-members">0</span></p>
			<p>Women professors: <span id="women-professors">0</span></p>
			<p>Year: <span id="year">0</span></p>
		</div>
		
	</div>
</div>
<!--[if gt IE 8]><!-->
<script type="text/javascript">
function buildParams () {
	var params = {};

	var contentWidth = jQuery("#content").width();

	params.mapScale = 100;
	params.zoomMin = 1;
	params.zoomMax = 8;
	params.ticks = 20;
	params.mapRatio = 0.5;
	params.mapBackground = "#E2EDF3";

	if ( contentWidth < 450 ) {
		params.mapScale = 50;
		params.ticks = 5;
		params.mapRatio = 0.8;
	}

	params.uiColour = {
		veryLightGrey: "#ddd",
		lightGrey: "#999",
		grey: "#666",
		darkGrey: "#333",
		noData: "#ccc",
		lineColour: "#cb181d",
		vaccinationLineColour: "#238b45"	
	};

	params.key = {
		keyRange: [0, 0.1, 0.2, 0.3],
		keyHead: "Cases of measles",
	};

	/* Target ids */
	params.mapTarget = "#chart";
	params.keyTarget = "#key";

	/*	Map margin, width and height */
	params.mapMargin = {top: 0, right: 15, bottom: 0, left: 15};
	params.mapWidth = contentWidth  - params.mapMargin.left - params.mapMargin.right;
	params.mapHeight = (contentWidth * params.mapRatio) - params.mapMargin.top - params.mapMargin.bottom;
	params.center = [ params.mapWidth / 2, params.mapHeight / 2];

	/*	barChart margin, width and height */
	params.barChartMargin = {top: 10, right: 10, bottom: 20, left: 70};
	params.barChartWidth = contentWidth - params.barChartMargin.left - params.barChartMargin.right - 30;
	params.barChartHeight = 100;

	params.format = d3.format("0,000");

	params.duration = 100;

	params.colour = d3.scale.linear()
					.range(["#a6bddb","#74a9cf","#2b8cbe","#045a8d"])
					.domain(params.key.keyRange)
					.clamp(true);

	params.projection = d3.geo.mercator()
						.scale(params.mapScale)
    					.translate([(params.mapWidth * 0.5), (params.mapHeight * 0.6)]);

	params.path = d3.geo.path()
					.projection(params.projection);

	return params;
}

function BuildWidget (params, features, worldData) {
	this.params = params;
	this.features = features;
	this.world = worldData;
	this.pubsub = {};
}
BuildWidget.prototype.buildKey = function() {
	var self = this;

	if ( !this.key ) {
		this.key = d3.select(this.params.keyTarget);
	}

	this.list = this.key.append("ul");

	this.list.selectAll("li")
			.data(this.params.key.keyRange)
			.enter()
		  .append("li")
			.text(function (d,i) {
				// if (i === (self.params.key.keyRange.length - 1) ) {
				// 	return "≥ " + self.params.format(d);
				// } else if (i === 0) {
				// 	return "≤ " + self.params.format(d);
				// } else {
				// 	return self.params.format(d);
				// }
				var number = d * 100;

				return "≥ " + number.toString() + "%";
			})
			.style("border-top-color", function (d) {
				return self.params.colour(d);
			});
	  
	this.list.append("li")
		.text("Not available")
		.style("border-top-color", self.params.uiColour.noData);


};

BuildWidget.prototype.buildTooltip = function () {
	var self = this;

	function formatPercent(num) {
		if (num === 0) {
			return "Not available";
		} else {
			return Math.floor((num * 100)) + "%";
		}
	}

	this.countriesSvg.selectAll("path")
		.on("mouseover", function (d) {			

			if (d.data) {
				var myCountry = d3.select(this);
				myCountry.attr("stroke-width", 1);

				var tooltipWidth = parseInt(d3.select("#widget-tooltip").style("padding-left"),10) + parseInt(d3.select("#widget-tooltip").style("width"),10) + parseInt(d3.select("#widget-tooltip").style("padding-right"),10);

				var coordinates = d3.mouse(self.svg[0][0]);

				var top = coordinates[1];
				var left = coordinates[0];

				if ( coordinates[0] > (self.params.mapWidth * 0.75) ) {
					left -= tooltipWidth;
				}

				d3.select("#widget-tooltip")
					.style("top",  top + "px")
					.style("left", left + "px")
					.classed("widget-tooltip-hidden", false);
				
				d3.select("#country").text(d.data.country);
				d3.select("#academy").text(d.data.academy);
				d3.select("#women-members").text( formatPercent(d.data["women-members"]) );
				d3.select("#women-professors").text( formatPercent(d.data["women-professors"]) );
				d3.select("#year").text(d.data.year === 0 ? "Not available" : d.data.year);
			}

		}).on("mouseout", function () {
			d3.select(this).attr("stroke-width", 0);
			self.hideTooltip();
		});
};

BuildWidget.prototype.hideTooltip = function () {
	d3.select("#widget-tooltip").classed("widget-tooltip-hidden", true);
};

BuildWidget.prototype.buildMap = function() {
	var self = this;

	this.svg = d3.select(this.params.mapTarget).append("svg")
					.attr("width", this.params.mapWidth)
					.attr("height", this.params.mapHeight);

	this.svgBG = this.svg.append("rect")
						.attr("x", 0)
						.attr("y", 0)
						.attr("width", this.params.mapWidth)
						.attr("height", this.params.mapHeight)
						.attr("fill", this.params.mapBackground);
				  
	this.defs = this.svg.append("defs").append("svg:clipPath")
					.attr("id", "clip")
				  .append("svg:rect")
					.attr("x", 0)
					.attr("y", 0)
					.attr("width", this.params.mapWidth)
					.attr("height", this.params.mapHeight);

	this.clipGroupSvg = this.svg.append("g").attr("clip-path", "url(#clip)");

	this.countriesSvg = this.clipGroupSvg.append("g").attr("class","country");
	this.bordersSvg = this.clipGroupSvg.append("g");

	this.zoom = d3.behavior.zoom()
					.translate([0, 0])
					.scale(1)
					.scaleExtent([this.params.zoomMin, this.params.zoomMax])
					.on("zoom", zoomed);

	this.svg.call(this.zoom);

	this.countriesSvg.selectAll("path")
		.data(this.features)
		.enter().append("path")
		.attr("d", this.params.path)
		.attr("id", function (d) {
			return d.id;
		})
		.attr("stroke-width", 0)
		.attr("stroke", "#666")
		.attr("fill", function (d) {
			if ( d.data ) {
					if ( d.data["women-members"] === 0) {
						return self.params.uiColour.noData;
					} else {
						return self.params.colour(d.data["women-members"]);
					}		

			} else {
				return self.params.uiColour.noData;
			}
		});

	this.bordersSvg.append("path")
		.datum(topojson.mesh(self.world, self.world.objects.units, function(a, b) { return a !== b; }))
		.attr("d", this.params.path)
		.attr("class", "subunit-boundary")
		.attr("fill", "none")
		.attr("stroke", "#666")
		.attr("stroke-width", "0.1px");
	
	function zoomed() {
		self.hideTooltip();
		self.countriesSvg.attr("transform", "translate(" + d3.event.translate + ") scale(" + d3.event.scale + ")");
		self.bordersSvg.attr("transform", "translate(" + d3.event.translate + ") scale(" + d3.event.scale + ")");
	}

};

var data = [
{
	"academy": "Cuban Academy of Sciences [**]",
	"country": "Cuba",
	"women-members": 0.27,
	"women-professors": 0.484,
	"year": 2012,
	"code": "CUB"
},
{
	"academy": "Caribbean Academy of Sciences [*]",
	"country": "Caribbean",
	"women-members": 0.26,
	"women-professors": 0,
	"year": 0,
	"code": 0
},
{
	"academy": "Academy of Sciences of the Czech Republic",
	"country": "Czech Republic",
	"women-members": 0.24,
	"women-professors": 0.275,
	"year": 2012,
	"code": "CZE"
},
{
	"academy": "Academy of Science of South Africa",
	"country": "South Africa",
	"women-members": 0.24,
	"women-professors": 0.437,
	"year": 2012,
	"code": "ZAF"
},
{
	"academy": "Academia Mexicana de Ciencias  [*]",
	"country": "Mexico",
	"women-members": 0.23,
	"women-professors": 0.316,
	"year": 2003,
	"code": "MEX"
},
{
	"academy": "Nicaraguan Academy of Sciences [*]",
	"country": "Nicaragua",
	"women-members": 0.23,
	"women-professors": 0.425,
	"year": 2002,
	"code": "NIC"
},
{
	"academy": "Academia Nacional de Ciencias",
	"country": "Peru",
	"women-members": 0.2,
	"women-professors": 0,
	"year": 0,
	"code": "PER"
},
{
	"academy": "National Academy of Sciences of Uruguay [*]",
	"country": "Uruguay",
	"women-members": 0.19,
	"women-professors": 0.496,
	"year": 2012,
	"code": "URY"
},
{
	"academy": "National Academy of Sciences of Sri Lanka",
	"country": "Sri Lanka",
	"women-members": 0.18,
	"women-professors": 0.368,
	"year": 2010,
	"code": "LKA"
},
{
	"academy": "Latvian Academy of Sciences",
	"country": "Latvia",
	"women-members": 0.18,
	"women-professors": 0.528,
	"year": 2012,
	"code": "LVA"
},
{
	"academy": "National Academy of Sciences of Honduras [*]",
	"country": "Honduras",
	"women-members": 0.17,
	"women-professors": 0.265,
	"year": 2003,
	"code": "HND"
},
{
	"academy": "Finnish Academy of Science and Letters",
	"country": "Finland",
	"women-members": 0.17,
	"women-professors": 0.322,
	"year": 2012,
	"code": "FIN"
},
{
	"academy": "Science Council of Japan",
	"country": "Japan",
	"women-members": 0.17,
	"women-professors": 0.146,
	"year": 2013,
	"code": "JPN"
},
{
	"academy": "Swiss Academy of Medical Sciences",
	"country": "Switzerland",
	"women-members": 0.17,
	"women-professors": 0.324,
	"year": 2012,
	"code": "CHE"
},
{
	"academy": "Royal Society of Canada [*]",
	"country": "Canada",
	"women-members": 0.16,
	"women-professors": 0,
	"year": 0,
	"code": "CAN"
},
{
	"academy": "Academy of Sciences Malaysia",
	"country": "Malaysia",
	"women-members": 0.15,
	"women-professors": 0.487,
	"year": 2011,
	"code": "MYS"
},
{
	"academy": "Academy of Sciences and Arts of Bosnia and Herzegovina",
	"country": "Bosnia and Herzegovina",
	"women-members": 0.15,
	"women-professors": 0,
	"year": 0,
	"code": "BIH"
},
{
	"academy": "Royal Irish Academy",
	"country": "Ireland",
	"women-members": 0.14,
	"women-professors": 0.324,
	"year": 2011,
	"code": "IRL"
},
{
	"academy": "Venezuelan Academy of Physical, Mathematical and Natural Sciences [*]",
	"country": "Venezuela",
	"women-members": 0.14,
	"women-professors": 0.574,
	"year": 2011,
	"code": "VEN"
},
{
	"academy": "National Academy of Sciences of Costa Rica [*]",
	"country": "Costa Rica",
	"women-members": 0.14,
	"women-professors": 0.43,
	"year": 2011,
	"code": "CRI"
},
{
	"academy": "Royal Netherlands Academy of Arts and Sciences",
	"country": "Netherlands",
	"women-members": 0.14,
	"women-professors": 0.241,
	"year": 2011,
	"code": "NLD"
},
{
	"academy": "Colombian Academy of Exact, Physical and Natural Sciences [*]",
	"country": "Colombia",
	"women-members": 0.14,
	"women-professors": 0.378,
	"year": 2012,
	"code": "COL"
},
{
	"academy": "Austrian Academy of Sciences",
	"country": "Austria",
	"women-members": 0.13,
	"women-professors": 0.29,
	"year": 2011,
	"code": "AUT"
},
{
	"academy": "Academy of Sciences of the Dominican Republic [*]",
	"country": "Dominican Republic",
	"women-members": 0.13,
	"women-professors": 0,
	"year": 0,
	"code": "DOM"
},
{
	"academy": "Brazilian Academy of Sciences [**]",
	"country": "Brazil",
	"women-members": 0.13,
	"women-professors": 0.497,
	"year": 2010,
	"code": "BRA"
},
{
	"academy": "Uganda National Academy of Sciences",
	"country": "Uganda",
	"women-members": 0.13,
	"women-professors": 0.243,
	"year": 2010,
	"code": "UGA"
},
{
	"academy": "The Royal Swedish Academy of Sciences",
	"country": "Sweden",
	"women-members": 0.13,
	"women-professors": 0.372,
	"year": 2011,
	"code": "SWE"
},
{
	"academy": "US National Academy of Sciences (NAS)",
	"country": "United States",
	"women-members": 0.13,
	"women-professors": 0,
	"year": 0,
	"code": "USA"
},
{
	"academy": "Academy of Medical, Physical and Natural Sciences [***]",
	"country": "Guatemala",
	"women-members": 0.12,
	"women-professors": 0.447,
	"year": 2012,
	"code": "GTM"
},
{
	"academy": "Chilean Academy of Sciences [*]",
	"country": "Chile",
	"women-members": 0.12,
	"women-professors": 0.308,
	"year": 2012,
	"code": "CHL"
},
{
	"academy": "National Academy of Exact, Physical and Natural Sciences [*]",
	"country": "Argentina",
	"women-members": 0.12,
	"women-professors": 0.512,
	"year": 2012,
	"code": "ARG"
},
{
	"academy": "Ghana Academy of Arts and Sciences",
	"country": "Ghana",
	"women-members": 0.11,
	"women-professors": 0.183,
	"year": 2010,
	"code": "GHA"
},
{
	"academy": "Cameroon Academy of Sciences",
	"country": "Cameroon",
	"women-members": 0.11,
	"women-professors": 0.218,
	"year": 2008,
	"code": "CMR"
},
{
	"academy": "Academy of Sciences of Albania",
	"country": "Albania",
	"women-members": 0.1,
	"women-professors": 0.443,
	"year": 2008,
	"code": "ALB"
},
{
	"academy": "Croatian Academy of Sciences and Arts",
	"country": "Croatia",
	"women-members": 0.1,
	"women-professors": 0.477,
	"year": 2012,
	"code": "HRV"
},
{
	"academy": "German National Academy of Sciences Leopoldina",
	"country": "Germany",
	"women-members": 0.1,
	"women-professors": 0.268,
	"year": 2011,
	"code": "DEU"
},
{
	"academy": "Hassan II Academy of Science and Technology",
	"country": "Morocco",
	"women-members": 0.1,
	"women-professors": 0.302,
	"year": 2011,
	"code": "MAR"
},
{
	"academy": "Australian Academy of Science",
	"country": "Australia",
	"women-members": 0.1,
	"women-professors": 0,
	"year": 0,
	"code": "AUS"
},
{
	"academy": "Swiss Academy of Engineering Sciences",
	"country": "Switzerland",
	"women-members": 0.1,
	"women-professors": 0.324,
	"year": 2012,
	"code": "CHE"
},
{
	"academy": "Serbian Academy of Sciences and Arts",
	"country": "Serbia",
	"women-members": 0.09,
	"women-professors": 0.493,
	"year": 2011,
	"code": "SRB"
},
{
	"academy": "Montenegrin Academy of Sciences and Arts",
	"country": "Montenegro",
	"women-members": 0.09,
	"women-professors": 0.499,
	"year": 2011,
	"code": "MNE"
},
{
	"academy": "Nigerian Academy of Science",
	"country": "Nigeria",
	"women-members": 0.09,
	"women-professors": 0.233,
	"year": 2007,
	"code": "NGA"
},
{
	"academy": "Royal Society of New Zealand",
	"country": "New Zealand",
	"women-members": 0.09,
	"women-professors": 0.52,
	"year": 2001,
	"code": "NZL"
},
{
	"academy": "Turkish Academy of Sciences",
	"country": "Turkey",
	"women-members": 0.09,
	"women-professors": 0.362,
	"year": 2013,
	"code": "TUR"
},
{
	"academy": "National Academy of Sciences of Bolivia [*]",
	"country": "Bolivia",
	"women-members": 0.09,
	"women-professors": 0.653,
	"year": 2010,
	"code": "BOL"
},
{
	"academy": "Real Academia de Ciencias Exactas, Físicas y Naturales",
	"country": "Spain",
	"women-members": 0.08,
	"women-professors": 0.388,
	"year": 2012,
	"code": "ESP"
},
{
	"academy": "Académie des sciences – Institut de France",
	"country": "France",
	"women-members": 0.08,
	"women-professors": 0.256,
	"year": 2012,
	"code": "FRA"
},
{
	"academy": "Pakistan Academy of Sciences",
	"country": "Pakistan",
	"women-members": 0.08,
	"women-professors": 0.272,
	"year": 2011,
	"code": "PAK"
},
{
	"academy": "Georgian National Academy of Sciences",
	"country": "Georgia",
	"women-members": 0.08,
	"women-professors": 0.527,
	"year": 2005,
	"code": "GEO"
},
{
	"academy": "Bangladesh Academy of Sciences (BAS)",
	"country": "Bangladesh",
	"women-members": 0.07,
	"women-professors": 0.14,
	"year": 1997,
	"code": "BGD"
},
{
	"academy": "Kenya National Academy of Sciences",
	"country": "Kenya",
	"women-members": 0.07,
	"women-professors": 0.257,
	"year": 2010,
	"code": "KEN"
},
{
	"academy": "Palestine Academy for Science and Technology",
	"country": "Palestine",
	"women-members": 0.07,
	"women-professors": 0.249,
	"year": 2010,
	"code": "PSE"
},
{
	"academy": "The Royal Society",
	"country": "United Kingdom",
	"women-members": 0.06,
	"women-professors": 0.378,
	"year": 2012,
	"code": "GBR"
},
{
	"academy": "Sudanese National Academy of Sciences",
	"country": "Sudan",
	"women-members": 0.06,
	"women-professors": 0.4,
	"year": 2005,
	"code": "SDN"
},
{
	"academy": "Indian National Science Academy",
	"country": "India",
	"women-members": 0.06,
	"women-professors": 0.15,
	"year": 2010,
	"code": "IND"
},
{
	"academy": "Chinese Academy of Sciences",
	"country": "China",
	"women-members": 0.06,
	"women-professors": 0,
	"year": 0,
	"code": "CHN"
},
{
	"academy": "Accademia Nazionale dei Lincei",
	"country": "Italy",
	"women-members": 0.05,
	"women-professors": 0.355,
	"year": 2012,
	"code": "ITA"
},
{
	"academy": "Slovenian Academy of Sciences and Arts",
	"country": "Slovenia",
	"women-members": 0.05,
	"women-professors": 0.358,
	"year": 2012,
	"code": "SVN"
},
{
	"academy": "Hungarian Academy of Sciences",
	"country": "Hungary",
	"women-members": 0.05,
	"women-professors": 0.309,
	"year": 2012,
	"code": "HUN"
},
{
	"academy": "Ethiopian Academy of Sciences",
	"country": "Ethiopia",
	"women-members": 0.05,
	"women-professors": 0.076,
	"year": 2010,
	"code": "ETH"
},
{
	"academy": "Mongolian Academy of Sciences",
	"country": "Mongolia",
	"women-members": 0.05,
	"women-professors": 0.492,
	"year": 2011,
	"code": "MNG"
},
{
	"academy": "Polish Academy of Sciences",
	"country": "Poland",
	"women-members": 0.04,
	"women-professors": 0.383,
	"year": 2012,
	"code": "POL"
},
{
	"academy": "Tanzania Academy of Sciences",
	"country": "Tanzania",
	"women-members": 0.04,
	"women-professors": 0.254,
	"year": 2010,
	"code": "TZA"
}
];
(function() {
	var init = function($)	{
		/*	Load D3 */
		// var countriesURL = "http://www.nature.com/widget_assets_polopoly/v518n7538/countries.json";
		var countriesURL = "data/countries.json";
		// var d3URL = "http://www.nature.com/widget_assets_polopoly/v518n7538/d3.v3.min.js";
		var d3URL = "data/d3.v3.min.js";
		// var topojsonURL = "http://www.nature.com/widget_assets_polopoly/v518n7538/topojson.v1.min.js";
		var topojsonURL = "data/topojson.v1.min.js";

		$.when( $.getScript(d3URL), $.getScript(topojsonURL))
			.then(function () {
				var worldData;

				d3.json(countriesURL, function (error, world) {
					if (error) {
						$(".widget-error-message").css("display", "block");
						console.log(error);
					} else {
						worldData = world;
						buildGraphic();
					}
				});

				function buildGraphic() {
					$(".outerwrapper").css("display","block");

					var features = topojson.feature(worldData, worldData.objects.units).features;
					var params = buildParams();

					for (var i = 0; i < features.length; i++) {

						for (var j = 0; j < data.length; j++) {
							if (data[j].code === features[i].id) {
								features[i].data = data[j];
								// need to work out what to do with Switzerland
							}
						}
					}

					var map = new BuildWidget(params, features, worldData);

					/*	Call functions to bulid the map */
					map.buildMap();
					map.buildKey();
					map.buildTooltip();
				}

			});
	};

	setTimeout(function() {
		if (typeof jQuery !== 'undefined'){
			init(jQuery);
		} else {
			setTimeout(arguments.callee, 60);
		}
	}, 60);
})();
</script>
<!--<![endif]-->